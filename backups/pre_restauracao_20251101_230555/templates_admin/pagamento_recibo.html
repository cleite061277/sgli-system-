{% extends "admin/base_site.html" %}
{% load static %}

{% block title %}{{ pagamento.numero_pagamento }} - Recibo | HABITAT PRO{% endblock %}

{% block extrastyle %}
{{ block.super }}
<style>
    .recibo-container {
        max-width: 900px;
        margin: 40px auto;
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        overflow: hidden;
    }
    
    .recibo-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 30px;
        text-align: center;
    }
    
    .recibo-header h1 {
        font-size: 28px;
        margin: 0 0 10px 0;
        color: white;
        font-weight: 700;
        text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }
    
    .recibo-numero {
        font-size: 16px;
        opacity: 0.95;
        color: white;
    }
    
    .recibo-body {
        padding: 40px;
    }
    
    .info-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 25px;
        margin-bottom: 30px;
    }
    
    .info-item {
        padding: 15px;
        background: #f8f9fa;
        border-radius: 8px;
        border-left: 4px solid #667eea;
    }
    
    .info-label {
        font-size: 12px;
        color: #7f8c8d;
        text-transform: uppercase;
        font-weight: 600;
        margin-bottom: 5px;
    }
    
    .info-value {
        font-size: 16px;
        color: #2c3e50;
        font-weight: 600;
    }
    
    .info-value a {
        color: #3b82f6;
        text-decoration: none;
        transition: color 0.2s;
    }
    
    .info-value a:hover {
        color: #2563eb;
        text-decoration: underline;
    }
    
    .valor-destaque {
        grid-column: span 2;
        background: #e8f5e9;
        border-left-color: #27ae60;
        text-align: center;
    }
    
    .valor-destaque .info-value {
        font-size: 32px;
        color: #27ae60;
    }
    
    .status-badge {
        display: inline-block;
        padding: 8px 20px;
        border-radius: 20px;
        font-weight: 700;
        font-size: 14px;
    }
    
    .status-confirmado {
        background: #27ae60;
        color: white;
    }
    
    .status-pendente {
        background: #f39c12;
        color: white;
    }
    
    .acoes-container {
        border-top: 2px solid #ecf0f1;
        padding: 30px 40px;
        background: #fafbfc;
    }
    
    .acoes-container h2 {
        color: #2c3e50;
        margin: 0 0 20px 0;
        font-size: 18px;
    }
    
    .botoes-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 15px;
        margin-bottom: 20px;
    }
    
    .btn-acao {
        padding: 15px 20px;
        border: none;
        border-radius: 8px;
        font-size: 15px;
        font-weight: 700;
        cursor: pointer;
        transition: all 0.3s;
        text-decoration: none;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
    }
    
    .btn-email {
        background: #3b82f6;
        color: white;
    }
    
    .btn-email:hover {
        background: #2563eb;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    }
    
    .btn-whatsapp {
        background: #25D366;
        color: white;
    }
    
    .btn-whatsapp:hover {
        background: #1fb855;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(37, 211, 102, 0.3);
    }
    
    .btn-download {
        background: #667eea;
        color: white;
    }
    
    .btn-download:hover {
        background: #5568d3;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
    }
    
    .btn-voltar {
        display: inline-block;
        padding: 12px 24px;
        background: #95a5a6;
        color: white;
        text-decoration: none;
        border-radius: 6px;
        font-weight: 600;
        transition: all 0.3s;
    }
    
    .btn-voltar:hover {
        background: #7f8c8d;
    }
    
    @media (max-width: 768px) {
        .info-grid {
            grid-template-columns: 1fr;
        }
        
        .valor-destaque {
            grid-column: span 1;
        }
        
        .botoes-grid {
            grid-template-columns: 1fr;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="recibo-container">
    <!-- Header -->
    <div class="recibo-header">
        <h1>üìÑ RECIBO DE PAGAMENTO</h1>
        <p class="recibo-numero">{{ pagamento.numero_pagamento }}</p>
    </div>
    
    <!-- Body -->
    <div class="recibo-body">
        {% if messages %}
            {% for message in messages %}
            <div style="padding: 15px; margin-bottom: 20px; border-radius: 8px; 
                        background: {% if message.tags == 'success' %}#d4edda{% elif message.tags == 'error' %}#f8d7da{% endif %}; 
                        color: {% if message.tags == 'success' %}#155724{% elif message.tags == 'error' %}#721c24{% endif %};">
                {{ message }}
            </div>
            {% endfor %}
        {% endif %}
        
        <div class="info-grid">
            <div class="info-item">
                <div class="info-label">üë§ Locat√°rio</div>
                <div class="info-value">
                    {% if locatario %}
                    <a href="{% url 'admin:core_locatario_change' locatario.id %}" target="_blank">
                        {{ locatario.nome_razao_social }}
                    </a>
                    {% else %}-{% endif %}
                </div>
            </div>
            
            <div class="info-item">
                <div class="info-label">üìã CPF/CNPJ</div>
                <div class="info-value">{{ locatario.cpf_cnpj|default:"-" }}</div>
            </div>
            
            <div class="info-item">
                <div class="info-label">üè† Im√≥vel</div>
                <div class="info-value">
                    {% if imovel %}
                    <a href="{% url 'admin:core_imovel_change' imovel.id %}" target="_blank">
                        {{ imovel.endereco }}, {{ imovel.numero }}
                    </a>
                    {% else %}-{% endif %}
                </div>
            </div>
            
            <div class="info-item">
                <div class="info-label">üìÑ Comanda</div>
                <div class="info-value">
                    {% if comanda %}
                    <a href="{% url 'admin:core_comanda_change' comanda.id %}" target="_blank">
                        {{ comanda.numero_comanda }}
                    </a>
                    {% else %}-{% endif %}
                </div>
            </div>
            
            <div class="info-item">
                <div class="info-label">üìÖ Data do Pagamento</div>
                <div class="info-value">{{ pagamento.data_pagamento|date:"d/m/Y" }}</div>
            </div>
            
            <div class="info-item">
                <div class="info-label">üí≥ Forma de Pagamento</div>
                <div class="info-value">{{ pagamento.get_forma_pagamento_display }}</div>
            </div>
            
            <div class="info-item">
                <div class="info-label">üìä Status</div>
                <div class="info-value">
                    <span class="status-badge {% if pagamento.status == 'CONFIRMADO' %}status-confirmado{% else %}status-pendente{% endif %}">
                        {% if pagamento.status == 'CONFIRMADO' %}‚úÖ{% else %}‚è≥{% endif %} 
                        {{ pagamento.get_status_display }}
                    </span>
                </div>
            </div>
            
            <div class="info-item valor-destaque">
                <div class="info-label">üí∞ Valor Pago</div>
                <div class="info-value">R$ {{ pagamento.valor_pago|floatformat:2 }}</div>
            </div>
        </div>
        
        {% if pagamento.observacoes %}
        <div class="info-item" style="margin-top: 20px;">
            <div class="info-label">üìù Observa√ß√µes</div>
            <div class="info-value" style="font-weight: 400;">{{ pagamento.observacoes }}</div>
        </div>
        {% endif %}
    </div>
    
    <!-- A√ß√µes -->
    <div class="acoes-container">
        <h2>‚ö° Enviar ou Baixar Recibo</h2>
        
        <div class="botoes-grid">
            <form method="post" style="margin: 0;">
                {% csrf_token %}
                <input type="hidden" name="action" value="email">
                <button type="submit" class="btn-acao btn-email">
                    üìß Enviar por Email
                </button>
            </form>
            
            <form method="post" style="margin: 0;">
                {% csrf_token %}
                <input type="hidden" name="action" value="whatsapp">
                <button type="submit" class="btn-acao btn-whatsapp">
                    üí¨ Enviar WhatsApp
                </button>
            </form>
            
            <a href="/pagamento/{{ pagamento.id }}/recibo/download/" class="btn-acao btn-download" target="_blank">
                üì• Download Word
            </a>
        </div>
        
        <a href="{% url 'admin:core_pagamento_changelist' %}" class="btn-voltar">
            ‚Üê Voltar para Pagamentos
        </a>
    </div>
</div>

<script>
// Redirect autom√°tico para WhatsApp
{% if request.session.whatsapp_redirect %}
(function() {
    const whatsappUrl = "{{ request.session.whatsapp_redirect|escapejs }}";
    console.log('Abrindo WhatsApp:', whatsappUrl);
    
    // Verificar se URL √© v√°lida
    if (whatsappUrl && whatsappUrl.startsWith('https://wa.me/')) {
        // Abrir em nova aba
        window.open(whatsappUrl, '_blank');
    }
    
    // Limpar sess√£o (fazer request para limpar)
    fetch(window.location.href, {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: 'action=clear_whatsapp_session'
    });
})();
{% endif %}
</script>
{% endblock %}
