from rest_framework import viewsets, status
from rest_framework.decorators import action
from rest_framework.response import Response
from rest_framework.permissions import IsAuthenticated
from django_filters.rest_framework import DjangoFilterBackend
from rest_framework import filters
from datetime import datetime

# Imports b√°sicos que sabemos que funcionam
from .models import Usuario, Locador, Imovel, Locatario, Locacao, Comanda, Pagamento
from .serializers import (
    UsuarioSerializer, LocadorSerializer, ImovelSerializer,
    LocatarioSerializer, LocacaoSerializer, ComandaSerializer, PagamentoSerializer
)

# ViewSets b√°sicos que funcionavam antes
class UsuarioViewSet(viewsets.ModelViewSet):
    queryset = Usuario.objects.all()
    serializer_class = UsuarioSerializer
    permission_classes = [IsAuthenticated]

class LocadorViewSet(viewsets.ModelViewSet):
    queryset = Locador.objects.all()
    serializer_class = LocadorSerializer
    permission_classes = [IsAuthenticated]

class ImovelViewSet(viewsets.ModelViewSet):
    queryset = Imovel.objects.all()
    serializer_class = ImovelSerializer
    permission_classes = [IsAuthenticated]

class LocatarioViewSet(viewsets.ModelViewSet):
    queryset = Locatario.objects.all()
    serializer_class = LocatarioSerializer
    permission_classes = [IsAuthenticated]

class LocacaoViewSet(viewsets.ModelViewSet):
    queryset = Locacao.objects.all()
    serializer_class = LocacaoSerializer
    permission_classes = [IsAuthenticated]

class ComandaViewSet(viewsets.ModelViewSet):
    queryset = Comanda.objects.all()
    serializer_class = ComandaSerializer
    permission_classes = [IsAuthenticated]



from django.http import JsonResponse
from decimal import Decimal

def teste_simples(request):
    """View de teste sem qualquer autentica√ß√£o."""
    comandas = Comanda.objects.all()
    total = comandas.count()
    
    lista = []
    for c in comandas[:3]:
        lista.append({
            'numero': c.numero_comanda,
            'status': c.get_status_display()
        })
    
    return JsonResponse({
        'total': total,
        'comandas': lista,
        'funcionando': True
    })

class PagamentoViewSet(viewsets.ModelViewSet):
    """ViewSet for payment management."""
    queryset = Pagamento.objects.select_related('comanda', 'usuario_registro').all()
    serializer_class = PagamentoSerializer
    permission_classes = [IsAuthenticated]
    filter_backends = [DjangoFilterBackend, filters.SearchFilter, filters.OrderingFilter]
    filterset_fields = ['status', 'forma_pagamento', 'comanda']
    search_fields = ['numero_pagamento', 'comanda__numero_comanda']
    ordering_fields = ['data_pagamento', 'valor_pago', 'created_at']
    ordering = ['-data_pagamento']
    
    def perform_create(self, serializer):
        serializer.save(usuario_registro=self.request.user)


from django.http import FileResponse, HttpResponse, Http404
from django.contrib.auth.decorators import login_required
from django.contrib.admin.views.decorators import staff_member_required
from django.shortcuts import get_object_or_404
from .models import Pagamento
from .document_generator import DocumentGenerator
import os
import mimetypes

@staff_member_required
def download_recibo_pagamento(request, pagamento_id):
    """
    Download seguro de recibo de pagamento.
    Requer autentica√ß√£o de staff e gera/serve o arquivo sem expor filesystem.
    """
    # Buscar pagamento
    pagamento = get_object_or_404(Pagamento, id=pagamento_id)
    
    # Verificar permiss√£o
    if not request.user.has_perm('core.view_pagamento'):
        raise Http404("Permiss√£o negada")
    
    try:
        # Gerar recibo (ou pegar existente)
        generator = DocumentGenerator()
        filename = generator.gerar_recibo_pagamento(pagamento.id)
        
        # Caminho completo do arquivo
        file_path = os.path.join(generator.output_dir, filename)
        
        # Verificar se existe
        if not os.path.exists(file_path):
            raise Http404("Recibo n√£o encontrado")
        
        # Detectar tipo MIME
        content_type, _ = mimetypes.guess_type(file_path)
        if content_type is None:
            content_type = 'application/octet-stream'
        
        # Abrir arquivo
        with open(file_path, 'rb') as f:
            response = HttpResponse(f.read(), content_type=content_type)
            response['Content-Disposition'] = f'attachment; filename="{filename}"'
            
            # Log de auditoria (opcional)
            import logging
            logger = logging.getLogger(__name__)
            logger.info(
                f"Recibo baixado: {filename} por {request.user.username} "
                f"(Pagamento: {pagamento.numero_pagamento})"
            )
            
            return response
            
    except Exception as e:
        import logging
        logger = logging.getLogger(__name__)
        logger.error(f"Erro ao gerar recibo para pagamento {pagamento_id}: {e}")
        raise Http404(f"Erro ao gerar recibo: {str(e)}")



@staff_member_required
def pagina_recibo_pagamento(request, pagamento_id):
    """
    P√°gina dedicada para visualizar e enviar recibo de pagamento.
    """
    from django.shortcuts import render
    from django.contrib import messages
    
    # Buscar pagamento
    pagamento = get_object_or_404(Pagamento, id=pagamento_id)
    
    # Verificar permiss√£o
    if not request.user.has_perm('core.view_pagamento'):
        raise Http404("Permiss√£o negada")
    
    # Buscar dados relacionados (ANTES do POST)
    comanda = pagamento.comanda
    locacao = comanda.locacao if comanda else None
    locatario = locacao.locatario if locacao else None
    imovel = locacao.imovel if locacao else None
    
    # Dados para o template
    context = {
        'pagamento': pagamento,
        'comanda': comanda,
        'locacao': locacao,
        'locatario': locatario,
        'imovel': imovel,
        'title': f'Recibo {pagamento.numero_pagamento}',
    }
    
    # Se for requisi√ß√£o POST (envio de email/whatsapp)
    if request.method == 'POST':
        action = request.POST.get('action')
        
        # Limpar redirect do WhatsApp se existir
        if action == 'clear_whatsapp_session':
            request.session.pop('whatsapp_redirect', None)
            return HttpResponse('OK')
        
        if action == 'email':
            try:
                from django.core.mail import EmailMessage
                from django.conf import settings
                from .document_generator import DocumentGenerator
                
                # Gerar recibo
                generator = DocumentGenerator()
                filename = generator.gerar_recibo_pagamento(pagamento.id)
                file_path = os.path.join(generator.output_dir, filename)
                
                # Preparar email
                locatario_email = locatario.email if locatario else None
                
                if not locatario_email:
                    messages.error(request, '‚ùå Locat√°rio n√£o possui email cadastrado!')
                else:
                    assunto = f'Recibo de Pagamento - {pagamento.numero_pagamento}'
                    corpo = f'''
Prezado(a) {locatario.nome_razao_social},

Segue em anexo o recibo de pagamento referente ao im√≥vel {imovel.endereco}, {imovel.numero}.

Valor pago: R$ {pagamento.valor_pago}
Data: {pagamento.data_pagamento.strftime('%d/%m/%Y')}
Forma: {pagamento.get_forma_pagamento_display()}

Atenciosamente,
HABITAT PRO
Sistema de Gest√£o Imobili√°ria
'''
                    
                    email = EmailMessage(
                        subject=assunto,
                        body=corpo,
                        from_email=settings.EMAIL_HOST_USER,
                        to=[locatario_email],
                    )
                    
                    # Anexar recibo
                    with open(file_path, 'rb') as f:
                        email.attach(filename, f.read(), 'application/vnd.openxmlformats-officedocument.wordprocessingml.document')
                    
                    email.send()
                    
                    messages.success(request, f'üìß Email enviado com sucesso para {locatario_email}!')
                    
            except Exception as e:
                import logging
                logger = logging.getLogger(__name__)
                logger.error(f'Erro ao enviar email: {e}')
                messages.error(request, f'‚ùå Erro ao enviar email: {str(e)}')
        
        elif action == 'whatsapp':
            try:
                from core.notifications.message_formatter import MessageFormatter
                import urllib.parse
                
                # Telefone do locat√°rio
                telefone = locatario.telefone if locatario else None
                
                if not telefone:
                    messages.error(request, '‚ùå Locat√°rio n√£o possui telefone cadastrado!')
                else:
                    # Limpar telefone (apenas n√∫meros)
                    telefone_limpo = ''.join(filter(str.isdigit, telefone))
                    
                    # Adicionar c√≥digo do pa√≠s se n√£o tiver (Brasil = 55)
                    if not telefone_limpo.startswith('55'):
                        telefone_limpo = '55' + telefone_limpo
                    
                    # Gerar URL da p√°gina do recibo
                    recibo_url = request.build_absolute_uri(
                        f'/pagamento/{pagamento.id}/recibo/'
                    )
                    
                    # Formatar mensagem usando MessageFormatter (com link)
                    mensagem = MessageFormatter.formatar_mensagem_whatsapp_recibo(
                        pagamento, 
                        recibo_url=recibo_url
                    )
                    
                    # URL WhatsApp (igual comandas)
                    mensagem_encoded = urllib.parse.quote(mensagem)
                    whatsapp_url = f'https://wa.me/{telefone_limpo}?text={mensagem_encoded}'
                    
                    # Salvar URL na sess√£o (mais seguro que cookie)
                    request.session['whatsapp_redirect'] = whatsapp_url
                    messages.success(request, 'üí¨ Abrindo WhatsApp...')
                    
            except Exception as e:
                import logging
                logger = logging.getLogger(__name__)
                logger.error(f'Erro ao preparar WhatsApp: {e}')
                messages.error(request, f'‚ùå Erro ao enviar WhatsApp: {str(e)}')
    
    # Limpar redirect WhatsApp ap√≥s renderizar (para n√£o redirecionar novamente)
    whatsapp_redirect_temp = request.session.get('whatsapp_redirect')
    if whatsapp_redirect_temp and request.method == 'GET':
        # Manter na primeira renderiza√ß√£o, limpar depois
        pass
    
    return render(request, 'admin/pagamento_recibo.html', context)
    
    
from django.contrib.admin.views.decorators import staff_member_required
from django.shortcuts import render, get_object_or_404
from .models import Pagamento

@staff_member_required
def visualizar_recibo_pagamento(request, pagamento_id):
    """Exibe recibo em modal HTML bonito"""
    pagamento = get_object_or_404(Pagamento, pk=pagamento_id)
    
    context = {
        'pagamento': pagamento,
        'comanda': pagamento.comanda,
        'locacao': pagamento.comanda.locacao,
        'locatario': pagamento.comanda.locacao.locatario,
        'imovel': pagamento.comanda.locacao.imovel,
    }
    
    return render(request, 'admin/recibo_modal.html', context)



@staff_member_required
def comanda_web_view(request, comanda_id):
    """P√°gina web da comanda"""
    from django.shortcuts import render, get_object_or_404
    from .models import Comanda
    from django.utils import timezone
    
    comanda = get_object_or_404(Comanda, id=comanda_id)
    loc = comanda.locacao
    
    hoje = timezone.now().date()
    dias_atraso = (hoje - comanda.data_vencimento).days if hoje > comanda.data_vencimento else 0
    
    context = {
        'titulo': f'Comanda {comanda.numero_comanda}',
        'comanda': comanda,
        'locacao': loc,
        'locatario_nome': loc.locatario.nome_razao_social,
        'imovel_endereco': f'{loc.imovel.endereco}, {loc.imovel.numero}',
        'numero_comanda': comanda.numero_comanda,
        'data_vencimento': comanda.data_vencimento.strftime('%d/%m/%Y'),
        'valor_aluguel': f'{comanda.valor_aluguel:,.2f}',
        'valor_condominio': f'{comanda.valor_condominio:,.2f}',
        'valor_iptu': f'{comanda.valor_iptu:,.2f}',
        'valor_multa': f'{comanda.multa:,.2f}',
        'valor_juros': f'{comanda.juros:,.2f}',
        'valor_total': f'{comanda.valor_total:,.2f}',
        'tem_multa_juros': (comanda.multa > 0 or comanda.juros > 0),
        'dias_atraso': dias_atraso,
        'mensagem': f'Comanda referente ao im√≥vel {loc.imovel.endereco}.',
    }
    
    return render(request, 'admin/comanda_web.html', context)


@staff_member_required
def enviar_comanda_email(request, comanda_id):
    """Envia comanda por email"""
    from django.shortcuts import get_object_or_404, redirect
    from django.contrib import messages
    from django.core.mail import EmailMessage
    from django.conf import settings
    from .models import Comanda
    
    comanda = get_object_or_404(Comanda, id=comanda_id)
    loc = comanda.locacao.locatario
    
    if not loc.email:
        messages.error(request, f'‚ùå Locat√°rio sem email!')
        return redirect('admin:core_comanda_changelist')
    
    try:
        url = request.build_absolute_uri(f'/comanda/{comanda.id}/web/')
        corpo = f"Prezado(a) {loc.nome_razao_social},\n\nComanda: {comanda.numero_comanda}\nVencimento: {comanda.data_vencimento.strftime('%d/%m/%Y')}\nValor: R$ {comanda.valor_total:,.2f}\n\nVer: {url}\n\nHABITAT PRO"
        
        email = EmailMessage(
            subject=f'Comanda {comanda.numero_comanda}',
            body=corpo,
            from_email=settings.DEFAULT_FROM_EMAIL,
            to=[loc.email],
        )
        email.send()
        messages.success(request, f'üìß Email enviado para {loc.email}!')
    except Exception as e:
        messages.error(request, f'‚ùå Erro: {e}')
    
    return redirect('admin:core_comanda_changelist')
