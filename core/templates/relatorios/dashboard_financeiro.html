{% load static %}
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HABITAT PRO - Dashboard Financeiro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .gradient-blue { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .gradient-green { background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); }
        .gradient-red { background: linear-gradient(135deg, #ee0979 0%, #ff6a00 100%); }
        .gradient-orange { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
        .card-hover { transition: all 0.3s ease; cursor: pointer; }
        .card-hover:hover { transform: translateY(-5px); box-shadow: 0 20px 40px rgba(0,0,0,0.15); }
        .pulse-animation { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: .7; }
        }
        .alerta-badge { 
            position: absolute; 
            top: -8px; 
            right: -8px; 
            background: #ef4444; 
            color: white; 
            border-radius: 50%; 
            width: 24px; 
            height: 24px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-size: 12px; 
            font-weight: bold;
            animation: pulse 1.5s ease-in-out infinite;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Header -->
    <!-- Header com Melhorias -->
    <div class="gradient-blue text-white px-8 py-6 shadow-lg">
        <div class="max-w-7xl mx-auto">
            <div class="flex justify-between items-center">
                <div class="flex items-center gap-4">
                    <!-- ‚úÖ NOVO: Bot√£o Voltar -->
                    <a href="{% url 'admin:index' %}" class="bg-white bg-opacity-20 hover:bg-opacity-30 text-white px-4 py-2 rounded-lg font-semibold transition flex items-center gap-2">
                        <span>‚Üê</span> Voltar
                    </a>
                    
                    <!-- Logo SVG -->
                    <svg width="60" height="60" viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg">
                        <rect x="50" y="90" width="100" height="80" fill="#fff" opacity="0.2" rx="5"/>
                        <path d="M 40 90 L 100 40 L 160 90 Z" fill="#fff" opacity="0.9"/>
                        <rect x="85" y="130" width="30" height="40" fill="#667eea" rx="3"/>
                        <rect x="65" y="105" width="20" height="20" fill="#f5576c" opacity="0.8" rx="2"/>
                        <rect x="115" y="105" width="20" height="20" fill="#f5576c" opacity="0.8" rx="2"/>
                        <rect x="130" y="60" width="15" height="30" fill="#fff" opacity="0.7" rx="2"/>
                        <circle cx="100" cy="145" r="8" fill="#fff" opacity="0.9"/>
                        <text x="100" y="151" text-anchor="middle" font-family="Arial" font-size="12" font-weight="bold" fill="#667eea">H</text>
                    </svg>
                    
                    <!-- ‚úÖ MELHORADO: Texto clic√°vel com cores corretas -->
                    <a href="{% url 'admin:index' %}" style="text-decoration: none; color: inherit;">
                        <div>
                            <h1 class="text-3xl font-bold tracking-tight hover:opacity-90 transition">
                                <span style="color: #fff;">HABITAT</span> 
                                <span style="color: #fbbf24;">PRO</span>
                            </h1>
                            <p class="text-blue-100 mt-1 text-sm">Dashboard Financeiro & Analytics</p>
                        </div>
                    </a>
                </div>
                <div class="flex gap-3">
                    <form action="{% url 'enviar_relatorio_email' %}" method="post" onsubmit="return confirmarEnvioEmail(event)">
                        {% csrf_token %}
                        <button type="submit" class="bg-white text-blue-600 px-4 py-2 rounded-lg font-semibold hover:bg-blue-50 transition flex items-center gap-2">
                            <span>üìß</span> Enviar Email
                        </button>
                    </form>
                    <a href="{% url 'exportar_dashboard_excel' %}" class="bg-white text-blue-600 px-4 py-2 rounded-lg font-semibold hover:bg-blue-50 transition flex items-center gap-2">
                        <span>üìä</span> Excel
                    </a>
                    <a href="{% url 'exportar_dashboard_pdf' %}" class="bg-white text-blue-600 px-4 py-2 rounded-lg font-semibold hover:bg-blue-50 transition flex items-center gap-2">
                        <span>üìÑ</span> PDF
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Alertas -->
    {% if alertas %}
    <div class="max-w-7xl mx-auto px-8 py-4">
        {% for alerta in alertas %}
        <div class="bg-{% if alerta.tipo == 'warning' %}red{% else %}blue{% endif %}-50 border-l-4 border-{% if alerta.tipo == 'warning' %}red{% else %}blue{% endif %}-500 p-4 mb-2 rounded-lg">
            <div class="flex justify-between items-center">
                <div>
                    <p class="font-semibold text-{% if alerta.tipo == 'warning' %}red{% else %}blue{% endif %}-800">{{ alerta.titulo }}</p>
                    <p class="text-sm text-{% if alerta.tipo == 'warning' %}red{% else %}blue{% endif %}-700">{{ alerta.mensagem }}</p>
                </div>
                <a href="{{ alerta.link }}" class="text-{% if alerta.tipo == 'warning' %}red{% else %}blue{% endif %}-600 hover:text-{% if alerta.tipo == 'warning' %}red{% else %}blue{% endif %}-800 font-semibold text-sm">
                    {{ alerta.acao }} ‚Üí
                </a>
            </div>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <!-- Filtros (‚úÖ CORRIGIDO: Ano e M√™s separados) -->
    <div class="max-w-7xl mx-auto px-8 py-6">
        <div class="bg-white rounded-xl shadow-md p-6 mb-6">
            <form method="get" class="grid grid-cols-1 md:grid-cols-6 gap-4">
                <!-- ‚úÖ NOVO: Filtro de Ano -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Ano</label>
                    <select name="ano" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        {% for ano in anos_disponiveis %}
                        <option value="{{ ano }}" {% if ano == ano_selecionado %}selected{% endif %}>{{ ano }}</option>
                        {% endfor %}
                    </select>
                </div>
                <!-- ‚úÖ NOVO: Filtro de M√™s -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">M√™s</label>
                    <select name="mes" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        <option value="1" {% if mes_selecionado == 1 %}selected{% endif %}>Janeiro</option>
                        <option value="2" {% if mes_selecionado == 2 %}selected{% endif %}>Fevereiro</option>
                        <option value="3" {% if mes_selecionado == 3 %}selected{% endif %}>Mar√ßo</option>
                        <option value="4" {% if mes_selecionado == 4 %}selected{% endif %}>Abril</option>
                        <option value="5" {% if mes_selecionado == 5 %}selected{% endif %}>Maio</option>
                        <option value="6" {% if mes_selecionado == 6 %}selected{% endif %}>Junho</option>
                        <option value="7" {% if mes_selecionado == 7 %}selected{% endif %}>Julho</option>
                        <option value="8" {% if mes_selecionado == 8 %}selected{% endif %}>Agosto</option>
                        <option value="9" {% if mes_selecionado == 9 %}selected{% endif %}>Setembro</option>
                        <option value="10" {% if mes_selecionado == 10 %}selected{% endif %}>Outubro</option>
                        <option value="11" {% if mes_selecionado == 11 %}selected{% endif %}>Novembro</option>
                        <option value="12" {% if mes_selecionado == 12 %}selected{% endif %}>Dezembro</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Im√≥vel</label>
                    <select name="imovel" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                        <option value="todos">Todos os Im√≥veis</option>
                        {% for imovel in imoveis %}
                        <option value="{{ imovel.id }}" {% if filtros.imovel == imovel.id|stringformat:'s' %}selected{% endif %}>
                            {{ imovel.endereco }}, {{ imovel.numero }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                    <select name="status" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                        <option value="todos" {% if filtros.status == 'todos' %}selected{% endif %}>Todos</option>
                        <option value="pago" {% if filtros.status == 'pago' %}selected{% endif %}>Pagas</option>
                        <option value="pendente" {% if filtros.status == 'pendente' %}selected{% endif %}>Pendentes</option>
                        <option value="atrasado" {% if filtros.status == 'atrasado' %}selected{% endif %}>Atrasadas</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Visualiza√ß√£o</label>
                    <select name="visualizacao" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                        <option value="real" {% if filtros.visualizacao == 'real' %}selected{% endif %}>Dados Reais</option>
                        <option value="projecao" {% if filtros.visualizacao == 'projecao' %}selected{% endif %}>Com Proje√ß√£o (3 meses)</option>
                    </select>
                </div>
                <div class="flex items-end">
                    <button type="submit" class="w-full gradient-blue text-white px-4 py-2 rounded-lg font-semibold hover:opacity-90 transition">
                        üîÑ Atualizar
                    </button>
                </div>
            </form>
        </div>

        <!-- KPI Cards -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
            <!-- Receita Prevista -->
            <div class="bg-white rounded-xl shadow-md p-6 card-hover relative">
                <div class="flex items-center justify-between mb-4">
                    <div class="gradient-blue text-white p-3 rounded-lg">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                    </div>
                    {% if kpis.receita_prevista_alerta %}
                    <span class="alerta-badge pulse-animation">!</span>
                    {% endif %}
                </div>
                <p class="text-sm text-gray-600 mb-1">Receita Prevista</p>
                <p class="text-2xl font-bold text-gray-900">R$ {{ kpis.receita_prevista|floatformat:2 }}</p>
                <p class="text-xs text-gray-500 mt-2">
                    {% if kpis.receita_prevista_alerta %}
                        <span class="text-red-600">‚ö†Ô∏è Abaixo da meta</span>
                    {% else %}
                        <span class="text-green-600">‚úì No prazo</span>
                    {% endif %}
                </p>
            </div>

            <!-- Receita Realizada -->
            <div class="bg-white rounded-xl shadow-md p-6 card-hover">
                <div class="gradient-green text-white p-3 rounded-lg mb-4 inline-block">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                </div>
                <p class="text-sm text-gray-600 mb-1">Receita Realizada</p>
                <p class="text-2xl font-bold text-gray-900">R$ {{ kpis.receita_realizada|floatformat:2 }}</p>
                <p class="text-xs text-green-600 mt-2">{{ kpis.taxa_recebimento|floatformat:1 }}% da receita prevista</p>
            </div>

            <!-- Contratos Ativos -->
            <div class="bg-white rounded-xl shadow-md p-6 card-hover">
                <div class="gradient-orange text-white p-3 rounded-lg mb-4 inline-block">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                    </svg>
                </div>
                <p class="text-sm text-gray-600 mb-1">Contratos Ativos</p>
                <p class="text-2xl font-bold text-gray-900">{{ kpis.total_comandas }}</p>
                <p class="text-xs text-gray-500 mt-2">Comandas no per√≠odo</p>
            </div>

            <!-- Taxa de Inadimpl√™ncia -->
            <div class="bg-white rounded-xl shadow-md p-6 card-hover relative">
                <div class="flex items-center justify-between mb-4">
                    <div class="gradient-red text-white p-3 rounded-lg">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                        </svg>
                    </div>
                    {% if kpis.inadimplencia_alerta %}
                    <span class="alerta-badge pulse-animation">{{ kpis.comandas_atrasadas }}</span>
                    {% endif %}
                </div>
                <p class="text-sm text-gray-600 mb-1">Taxa de Inadimpl√™ncia</p>
                <p class="text-2xl font-bold text-gray-900">{{ kpis.taxa_inadimplencia|floatformat:2 }}%</p>
                <p class="text-xs {% if kpis.inadimplencia_alerta %}text-red-600{% else %}text-green-600{% endif %} mt-2">
                    Meta: &lt; 3%
                </p>
            </div>
        </div>

        <!-- Gr√°ficos -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
            <!-- Gr√°fico Receita -->
            <div class="bg-white rounded-xl shadow-md p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">üìà Receita √öltimos 12 Meses</h3>
                <div style="height: 300px;">
                    <canvas id="receitaChart"></canvas>
                </div>
            </div>

            <!-- Gr√°fico Inadimpl√™ncia -->
            <div class="bg-white rounded-xl shadow-md p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">‚ö†Ô∏è Taxa de Inadimpl√™ncia</h3>
                <div style="height: 300px;">
                    <canvas id="inadimplenciaChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Performance por Im√≥vel -->
        <div class="bg-white rounded-xl shadow-md p-6 mb-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">üè† Performance por Im√≥vel</h3>
            <div style="height: 400px;">
                <canvas id="imovelChart"></canvas>
            </div>
        </div>

        <!-- Tabelas -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- Pagamentos Recentes -->
            <div class="bg-white rounded-xl shadow-md p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">üí≥ Pagamentos Recentes</h3>
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead>
                            <tr class="border-b">
                                <th class="text-left py-3 px-2 text-sm font-semibold text-gray-700">Data</th>
                                <th class="text-left py-3 px-2 text-sm font-semibold text-gray-700">Locat√°rio</th>
                                <th class="text-right py-3 px-2 text-sm font-semibold text-gray-700">Valor</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for pag in ultimos_pagamentos %}
                            <tr class="border-b hover:bg-gray-50">
                                <td class="py-3 px-2 text-sm text-gray-600">{{ pag.data }}</td>
                                <td class="py-3 px-2 text-sm text-gray-900">
                                    <a href="{{ pag.numero_comanda_link }}" class="text-blue-600 hover:text-blue-800 font-medium">
                                        {{ pag.numero_comanda }}
                                    </a>
                                    <br>
                                    <span class="text-xs text-gray-500">{{ pag.inquilino }}</span>
                                </td>
                                <td class="py-3 px-2 text-sm text-right font-semibold text-green-600">
                                    R$ {{ pag.valor|floatformat:2 }}
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="3" class="py-6 text-center text-gray-500">
                                    Nenhum pagamento registrado
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Comandas Vencidas -->
            <div class="bg-white rounded-xl shadow-md p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">‚ö†Ô∏è Comandas Vencidas</h3>
                {% if alertas %}
                <div class="space-y-3">
                    {% for alerta in alertas %}
                    <div class="bg-red-50 border-l-4 border-red-500 p-3 rounded">
                        <p class="font-semibold text-red-800 text-sm">{{ alerta.titulo }}</p>
                        <p class="text-xs text-red-700 mt-1">{{ alerta.mensagem }}</p>
                        <a href="{{ alerta.link }}" class="text-red-600 hover:text-red-800 font-semibold text-xs mt-2 inline-block">
                            {{ alerta.acao }} ‚Üí
                        </a>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="text-center py-8">
                    <div class="text-green-500 text-5xl mb-2">‚úÖ</div>
                    <p class="text-gray-600 font-medium">Nenhuma comanda vencida</p>
                    <p class="text-sm text-gray-500 mt-1">Todas as cobran√ßas est√£o em dia!</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script>
        const dadosMensais = {{ dados_mensais|safe }};
        const performanceImoveis = {{ performance_imoveis|safe }};

        // Gr√°fico Receita
        const ctxReceita = document.getElementById('receitaChart').getContext('2d');
        new Chart(ctxReceita, {
            type: 'line',
            data: {
                labels: dadosMensais.map(d => d.mes),
                datasets: [{
                    label: 'Previsto',
                    data: dadosMensais.map(d => d.previsto),
                    borderColor: 'rgba(102, 126, 234, 1)',
                    backgroundColor: 'rgba(102, 126, 234, 0.1)',
                    borderWidth: 3,
                    fill: true,
                    tension: 0.4
                }, {
                    label: 'Realizado',
                    data: dadosMensais.map(d => d.realizado),
                    borderColor: 'rgba(17, 153, 142, 1)',
                    backgroundColor: 'rgba(17, 153, 142, 0.1)',
                    borderWidth: 3,
                    fill: true,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'top' },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                label += 'R$ ' + context.parsed.y.toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,');
                                return label;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return 'R$ ' + (value/1000).toFixed(0) + 'k';
                            }
                        }
                    }
                }
            }
        });

        // Gr√°fico Inadimpl√™ncia
        const ctxInadimplencia = document.getElementById('inadimplenciaChart').getContext('2d');
        new Chart(ctxInadimplencia, {
            type: 'line',
            data: {
                labels: dadosMensais.map(d => d.mes),
                datasets: [{
                    label: 'Taxa de Inadimpl√™ncia (%)',
                    data: dadosMensais.map(d => d.inadimplencia),
                    backgroundColor: 'rgba(238, 9, 121, 0.1)',
                    borderColor: 'rgba(238, 9, 121, 1)',
                    borderWidth: 3,
                    fill: true,
                    tension: 0.4
                }, {
                    label: 'Meta (3%)',
                    data: Array(dadosMensais.length).fill(3),
                    borderColor: 'rgba(34, 197, 94, 0.5)',
                    borderWidth: 2,
                    borderDash: [5, 5],
                    pointRadius: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { position: 'top' } },
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 10,
                        ticks: {
                            callback: function(value) {
                                return value + '%';
                            }
                        }
                    }
                }
            }
        });

        // Gr√°fico Im√≥veis
        const ctxImovel = document.getElementById('imovelChart').getContext('2d');
        new Chart(ctxImovel, {
            type: 'bar',
            data: {
                labels: performanceImoveis.map(i => i.nome),
                datasets: [{
                    label: 'Previsto',
                    data: performanceImoveis.map(i => i.previsto),
                    backgroundColor: 'rgba(102, 126, 234, 0.5)',
                    borderColor: 'rgba(102, 126, 234, 1)',
                    borderWidth: 1
                }, {
                    label: 'Realizado',
                    data: performanceImoveis.map(i => i.realizado),
                    backgroundColor: 'rgba(17, 153, 142, 0.5)',
                    borderColor: 'rgba(17, 153, 142, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                plugins: { 
                    legend: { position: 'top' },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                label += 'R$ ' + context.parsed.x.toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,');
                                return label;
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return 'R$ ' + (value/1000).toFixed(0) + 'k';
                            }
                        }
                    }
                }
            }
        });

        // Fun√ß√£o de confirma√ß√£o de email
        function confirmarEnvioEmail(event) {
            event.preventDefault();
            const email = prompt('Digite o email de destino:', '');
            if (email) {
                const form = event.target;
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = 'email';
                input.value = email;
                form.appendChild(input);
                form.submit();
            }
            return false;
        }
    </script>
</body>
</html>
