from django.db.models import Sum, Value, Q
from django.db.models.functions import Coalesce
from decimal import Decimal
from django.utils.html import format_html

# Limpado e corrigido por Copilot ‚Äî vers√£o recomendada
from django.contrib import admin
import uuid
from django.db import transaction, IntegrityError
from django.utils import timezone
from django.utils.html import format_html
from django.urls import reverse
from django.db.models import Sum, Q

from .models import (
    Usuario, Locador, Imovel, Locatario, Locacao,
    Comanda, Pagamento, Fiador, TemplateContrato,
    ConfiguracaoSistema, LogGeracaoComandas
)

from .forms import PagamentoAdminForm

# FormSet customizado para preencher usuario_registro
from django.forms import BaseInlineFormSet

class UsuarioAdmin(admin.ModelAdmin):
    """Admin organizado para Usuario"""
    list_display = ['username', 'get_full_name', 'email', 'tipo_usuario', 'is_staff', 'is_active', 'date_joined']
    list_filter = ['tipo_usuario', 'is_active', 'is_staff', 'date_joined']
    search_fields = ['username', 'email', 'first_name', 'last_name', 'cpf']

    fieldsets = (
        ('üîê Autentica√ß√£o', {'fields': ('username', 'password')}),
        ('üë§ Dados Pessoais', {'fields': ('first_name', 'last_name', 'email', 'cpf', 'telefone', 'avatar')}),
        ('üé≠ Perfil do Sistema', {'fields': ('tipo_usuario',)}),
        ('üîë Permiss√µes', {
            'fields': ('is_active', 'is_staff', 'is_superuser', 'groups', 'user_permissions'),
            'classes': ['collapse'],
        }),
        ('üìÖ Datas Importantes', {
            'fields': ('date_joined', 'last_login'),
            'classes': ['collapse'],
        }),
    )
    readonly_fields = ['date_joined', 'last_login']


# -----------------------
# Locador
# -----------------------
@admin.register(Locador)
class LocadorAdmin(admin.ModelAdmin):
    list_display = [
        'nome_razao_social',
        'representante',
        'tipo_locador',
        'cpf_cnpj',
        'telefone',
        'email',
        'is_active',
    ]
    list_filter = ['tipo_locador', 'is_active', 'created_at']
    search_fields = ['nome_razao_social', 'representante', 'cpf_cnpj', 'email', 'telefone']

    fieldsets = (
        ('üìã Dados B√°sicos', {'fields': ('usuario', 'tipo_locador', 'nome_razao_social', 'representante', 'cpf_cnpj')}),
        ('üìû Contatos', {'fields': ('telefone', 'email')}),
        ('üè† Endere√ßo', {'fields': ('endereco_completo', 'cep')}),
        ('üìù Observa√ß√µes', {'fields': ('observacoes',), 'classes': ['collapse']}),
        ('üïê Metadados', {'fields': ('created_at', 'updated_at', 'is_active'), 'classes': ['collapse']}),
    )
    readonly_fields = ['created_at', 'updated_at']


# -----------------------
# Im√≥vel
# -----------------------
@admin.register(Imovel)
class ImovelAdmin(admin.ModelAdmin):
    list_display = ['codigo_imovel', 'tipo_imovel', 'status', 'endereco', 'cidade', 'valor_aluguel', 'locador', 'is_active']
    list_filter = ['tipo_imovel', 'status', 'cidade', 'estado', 'is_active', 'created_at']
    search_fields = ['codigo_imovel', 'endereco', 'bairro', 'cidade', 'locador__nome_razao_social']

    fieldsets = (
        ('üìã Informa√ß√µes B√°sicas', {'fields': ('locador', 'codigo_imovel', 'tipo_imovel', 'status')}),
        ('üìç Endere√ßo', {'fields': ('endereco', 'numero', 'bairro', 'cidade', 'estado', 'cep')}),
        ('üìè Caracter√≠sticas', {'fields': ('area_total', 'quartos', 'banheiros')}),
        ('üí∞ Valores', {'fields': ('valor_aluguel', 'valor_condominio')}),
        ('‚ö° Utilidades / Contas', {
            'fields': ('conta_agua_esgoto', 'numero_hidrometro', 'unidade_consumidora_energia'),
            'description': 'Informa√ß√µes de contas de consumo do im√≥vel'
        }),
        ('üìù Descri√ß√£o', {'fields': ('descricao',), 'classes': ['collapse']}),
        ('üïê Metadados', {'fields': ('created_at', 'updated_at', 'is_active'), 'classes': ['collapse']}),
    )
    readonly_fields = ['created_at', 'updated_at']


# -----------------------
# Locat√°rio
# -----------------------
@admin.register(Locatario)
class LocatarioAdmin(admin.ModelAdmin):
    list_display = ['nome_razao_social', 'cpf_cnpj', 'telefone', 'email', 'empresa_trabalho', 'tem_fiador', 'is_active']
    list_filter = ['created_at', 'is_active']
    search_fields = ['nome_razao_social', 'cpf_cnpj', 'rg', 'email', 'telefone', 'empresa_trabalho']

    fieldsets = (
        ('üìã Dados Pessoais', {'fields': ('nome_razao_social', 'cpf_cnpj', 'rg', 'data_nascimento')}),
        ('üë®‚Äçüë©‚Äçüë¶ Filia√ß√£o', {'fields': ('nome_pai', 'nome_mae'), 'classes': ['collapse']}),
        ('üìû Contatos', {'fields': ('telefone', 'email', 'outro_telefone', ('nome_contato_emergencia', 'telefone_contato_emergencia'))}),
        ('üè† Endere√ßo', {'fields': ('endereco_completo',)}),
        ('üíº Dados Profissionais', {'fields': ('empresa_trabalho', 'endereco_empresa', 'telefone_empresa', 'contato_empresa', 'tempo_empresa', 'renda_mensal')}),
        ('üõ°Ô∏è Garantia', {'fields': ('fiador',), 'description': 'Selecione um fiador cadastrado ou deixe em branco se n√£o houver'}),
        ('üïê Metadados', {'fields': ('created_at', 'updated_at', 'is_active'), 'classes': ['collapse']}),
    )
    readonly_fields = ['created_at', 'updated_at']

    @admin.display(description='Fiador', boolean=True)
    def tem_fiador(self, obj):
        return obj.fiador is not None


# -----------------------
# Loca√ß√£o (contratos)
# -----------------------
@admin.register(Locacao)
class LocacaoAdmin(admin.ModelAdmin):
    """Admin atualizado com gera√ß√£o de contratos"""
    list_display = ('numero_contrato', 'imovel', 'locatario', 'status', 'data_inicio', 'data_fim')
    list_filter = ('status', 'is_active', 'created_at')
    search_fields = ('numero_contrato', 'imovel__codigo_imovel', 'locatario__nome_razao_social')
    readonly_fields = ['created_at', 'updated_at']

    actions = ['gerar_contrato_pdf_action', 'gerar_contrato_docx_action', 'gerar_contrato']

    fieldsets = (
        ('üìã Informa√ß√µes B√°sicas', {
            'fields': ('numero_contrato', 'imovel', 'locatario', 'status'),
            'description': '‚ö†Ô∏è Deixe o n√∫mero do contrato VAZIO para gerar automaticamente'
        }),
        ('üìÖ Datas', {'fields': ('data_inicio', 'data_fim')}),
        ('üí∞ Valores', {'fields': ('valor_aluguel', 'dia_vencimento')}),
        ('üïê Metadados', {'fields': ('created_at', 'updated_at', 'is_active'), 'classes': ['collapse']}),
    )

    def get_form(self, request, obj=None, **kwargs):
        """Remove required do numero_contrato para permitir gera√ß√£o autom√°tica"""
        form = super().get_form(request, obj, **kwargs)
        if 'numero_contrato' in form.base_fields:
            form.base_fields['numero_contrato'].required = False
            form.base_fields['numero_contrato'].help_text = '‚ú® Deixe vazio para gerar automaticamente'
        return form

    def change_view(self, request, object_id, form_url='', extra_context=None):
        """Adiciona bot√µes de gerar contrato."""
        extra_context = extra_context or {}
        obj = self.get_object(request, object_id)
        if obj:
            extra_context['show_contrato_buttons'] = True
            extra_context['contrato_docx_url'] = reverse('gerar_contrato_docx', args=[obj.pk])
            extra_context['contrato_pdf_url'] = reverse('gerar_contrato_pdf', args=[obj.pk])
        return super().change_view(request, object_id, form_url, extra_context)

    @admin.action(description='üìÑ Gerar Contrato PDF')
    def gerar_contrato_pdf_action(self, request, queryset):
        if queryset.count() == 1:
            from .contrato_generator import gerar_contrato_pdf
            return gerar_contrato_pdf(queryset.first())
        else:
            self.message_user(request, '‚ùå Selecione apenas UMA loca√ß√£o', level='error')

    @admin.action(description='üìù Gerar Contrato DOCX')
    def gerar_contrato_docx_action(self, request, queryset):
        if queryset.count() == 1:
            from .contrato_generator import gerar_contrato_docx
            return gerar_contrato_docx(queryset.first())
        else:
            self.message_user(request, '‚ùå Selecione apenas UMA loca√ß√£o', level='error')

    def gerar_contrato(self, request, queryset):
        """Gerar contratos em Word (bulk action)."""
        from .document_generator import DocumentGenerator
        generator = DocumentGenerator()

        contratos_gerados = []
        for locacao in queryset:
            try:
                filename = generator.gerar_contrato_locacao(locacao.id)
                contratos_gerados.append(filename)
            except Exception as e:
                self.message_user(request, f'Erro ao gerar contrato {locacao.numero_contrato}: {e}', level='ERROR')

        if contratos_gerados:
            self.message_user(request, f'{len(contratos_gerados)} contrato(s) gerado(s) com sucesso!')


# -----------------------
# Comanda
# -----------------------


class PagamentoInline(admin.TabularInline):
    model = Pagamento
    extra = 0
    fields = ['data_pagamento', 'valor_pago', 'forma_pagamento', 'status', 'comprovante', 'recibo_actions']
    readonly_fields = ['numero_pagamento', 'created_at', 'recibo_actions']

    def get_formset(self, request, obj=None, **kwargs):
        formset = super().get_formset(request, obj, **kwargs)
        formset.request = request
        return formset

    @admin.display(description='Recibo')
    def recibo_actions(self, obj):
        if not obj or not obj.pk:
            return '-'

        status = (getattr(obj, 'status', '') or '').lower()
        is_confirmed = status == 'confirmado' or status == getattr(obj.StatusPagamento, 'CONFIRMADO', '').lower()

        try:
            view_url = reverse('pagina_recibo_pagamento', args=[obj.pk])
            download_url = reverse('download_recibo_pagamento', args=[obj.pk])
        except Exception:
            view_url = f'/pagamento/{obj.pk}/recibo/'
            download_url = f'/pagamento/{obj.pk}/recibo/download/'

        if not is_confirmed:
            return format_html('<span style="color: #999; font-style: italic;">Aguardando confirma√ß√£o</span>')

        return format_html(
            '<a class="button" href="{}" target="_blank" style="background:#28a745;color:#fff;margin-right:6px;">üßæ Ver</a>'
            '<a class="button" href="{}" target="_blank" style="background:#667eea;color:#fff;margin-right:6px;">üì• Word</a>'
            '<a class="button" href="{}" style="background:#3b82f6;color:#fff;margin-right:6px;">üìß Email</a>',
            view_url, download_url, view_url
        )

    def save_new(self, form, formset, commit=True):
        obj = super().save_new(form, formset, commit=False)
        if not obj.usuario_registro_id and hasattr(formset, 'request'):
            obj.usuario_registro = formset.request.user
        if commit:
            obj.save()
        return obj

    def has_delete_permission(self, request, obj=None):
        if obj and getattr(obj, 'status', None) == 'confirmado':
            return False
        return True

@admin.register(Comanda)
class ComandaAdmin(admin.ModelAdmin):
    @admin.display(description='‚è∞ Dias de Atraso')
    def dias_atraso_display(self, obj):
        """
        Exibe os dias de atraso no admin (indenta√ß√£o correta dentro da classe).
        """
        from django.utils.html import format_html
        try:
            dias = obj.dias_atraso() if hasattr(obj, 'dias_atraso') else 0
        except Exception:
            dias = 0

        if dias == 0:
            return format_html('<span style="color: #28a745; font-size: 16px;">‚úì Em dia</span>')
        elif dias > 0:
            return format_html(
                '<span style="color: #dc3545; font-size: 16px; font-weight: bold;">‚ö†Ô∏è {} dia(s) de atraso</span>',
                dias
            )
        else:
            return format_html(
                '<span style="color: #17a2b8; font-size: 16px;">üìÖ Vence em {} dia(s)</span>',
                abs(dias)
            )
    # Bot√£o para enviar WhatsApp (implementa√ß√£o defensiva)
    @admin.display(description='WhatsApp')
    # Bot√£o para enviar WhatsApp (implementa√ß√£o defensiva)
    @admin.display(description='WhatsApp')
    def painel_whatsapp_button(self, obj):
        """
        Gera bot√£o/link para abrir o WhatsApp com mensagem itemizada e total da comanda.
        Implementa√ß√£o defensiva ‚Äî n√£o quebra o admin em caso de erro.
        """
        from django.utils.html import format_html
        from urllib.parse import quote_plus
        from decimal import Decimal
        from django.conf import settings

        try:
            # 1) localizar telefone de forma defensiva (v√°rias possibilidades)
            telefone = None
            if getattr(obj, 'locacao', None):
                loc = obj.locacao
                telefone = getattr(getattr(loc, 'locatario', None), 'telefone', None) or telefone
                telefone = getattr(getattr(loc, 'usuario_registro', None), 'telefone', None) or telefone
            # fallback: telefone direto no objeto
            telefone = telefone or getattr(obj, 'telefone', None) or getattr(obj, 'telefone_contato', None)

            if not telefone:
                return '-'

            # extrair apenas d√≠gitos
            digits = ''.join(ch for ch in str(telefone) if ch.isdigit())
            # prefixar DDI padr√£o se configurado e n√∫mero curto
            if getattr(settings, "WHATSAPP_DEFAULT_DDI", None) and len(digits) <= 11:
                digits = f"{settings.WHATSAPP_DEFAULT_DDI}{digits}"

            # valida√ß√£o simples: exige pelo menos 8 d√≠gitos
            if len(digits) < 8:
                return '-'

            # 2) tentar usar um formatter existente (se houver) - integra√ß√£o opcional
            texto = None
            try:
                from core.notifications import message_formatter as mf
                if hasattr(mf, "format_comanda_whatsapp"):
                    texto = mf.format_comanda_whatsapp(obj)
                elif hasattr(mf, "format_whatsapp_message"):
                    texto = mf.format_whatsapp_message(obj)
            except Exception:
                texto = None

            # 3) se n√£o houver formatter, montar a mensagem itemizada localmente
            if not texto:
                def dec(field):
                    try:
                        raw = getattr(obj, field, None)
                        return Decimal(raw or 0)
                    except Exception:
                        return Decimal(0)

                mapping = [
                    ("Aluguel", "valor_aluguel"),
                    ("Condom√≠nio", "valor_condominio"),
                    ("IPTU", "valor_iptu"),
                    ("Administra√ß√£o", "valor_administracao"),
                    ("Outros (cr√©dito)", "outros_creditos"),
                    ("Outros (d√©bito)", "outros_debitos"),
                    ("Multa", "valor_multa"),
                    ("Juros", "valor_juros"),
                    ("Desconto", "desconto"),
                ]

                itens = []
                for label, field in mapping:
                    val = dec(field)
                    if val and val != Decimal("0"):
                        if field in ("outros_creditos", "desconto"):
                            itens.append(f"{label}: -R$ {abs(val):,.2f}")
                        else:
                            itens.append(f"{label}: R$ {val:,.2f}")

                # total preferindo o m√©todo do modelo se existir
                total_oficial = None
                try:
                    if callable(getattr(obj, "valor_total", None)):
                        total_oficial = obj.valor_total()
                    else:
                        total_oficial = dec("valor_total")
                except Exception:
                    total_oficial = None

                if total_oficial in (None, 0):
                    soma_positivos = sum(dec(f) for _, f in mapping if f not in ("desconto", "outros_creditos"))
                    soma_creditos = dec("desconto") + dec("outros_creditos")
                    total_used = soma_positivos - soma_creditos
                else:
                    total_used = Decimal(total_oficial or 0)

                partes = []
                partes.append(f"Ol√°! Recibo da comanda {getattr(obj, 'numero_comanda', '')}")
                nome = ""
                try:
                    if getattr(obj, "locacao", None):
                        nome = getattr(getattr(obj.locacao, "locatario", None), "nome_razao_social", None) \
                            or getattr(getattr(obj.locacao, "usuario_registro", None), "get_full_name", None)
                    if not nome:
                        nome = getattr(obj, "locacao_info", None) or ""
                except Exception:
                    nome = ""
                if nome:
                    partes.append(f"Cliente: {nome}")

                partes.append("")  # linha em branco antes dos itens
                partes.append("Itens:")
                for it in itens:
                    partes.append(f"- {it}")

                partes.append("")  # linha em branco antes do total
                partes.append(f"Total: R$ {Decimal(total_used):,.2f}")

                texto = "\n".join(partes)

            # 4) codificar e construir URL
            texto_enc = quote_plus(texto)
            wa_url = f"https://wa.me/{digits}?text={texto_enc}"
            return format_html('<a class="button" href="{}" target="_blank">üí¨ WhatsApp</a>', wa_url)

        except Exception:
            return '-'
        """Bot√£o para visualizar pagamento"""
        url = reverse('admin:core_pagamento_change', args=[obj.pk])
        return format_html(
            '<a class="button" href="{}" target="_blank">üßæ Ver Detalhes</a>',
            url
        )

    @admin.action(description='üßæ Gerar recibo (Word)')
    def gerar_recibo(self, request, queryset):
        from .document_generator import DocumentGenerator
        generator = DocumentGenerator()
        recibos_gerados = []
        for pagamento in queryset:
            try:
                filename = generator.gerar_recibo_pagamento(pagamento.id)
                recibos_gerados.append(filename)
            except Exception as e:
                self.message_user(request, f'Erro ao gerar recibo {pagamento.numero_pagamento}: {e}', level='ERROR')
        if recibos_gerados:
            self.message_user(request, f'{len(recibos_gerados)} recibo(s) gerado(s) com sucesso!')


# -----------------------
# TemplateContrato
# -----------------------
# @admin.register(TemplateContrato)
class TemplateContratoAdmin(admin.ModelAdmin):
    list_display = ('nome', 'locador', 'tipo_imovel', 'is_default', 'created_at')
    list_filter = ('is_default', 'tipo_imovel', 'locador')
    search_fields = ('nome', 'descricao')
    fieldsets = (
        ('Informa√ß√µes B√°sicas', {'fields': ('nome', 'descricao', 'arquivo_template')}),
        ('Associa√ß√µes', {'fields': ('locador', 'tipo_imovel', 'is_default'), 'description': 'Defina quando este template deve ser usado'})
    )


# -----------------------
# ConfiguracaoSistema (singleton)
# -----------------------
@admin.register(ConfiguracaoSistema)
class ConfiguracaoSistemaAdmin(admin.ModelAdmin):
    fieldsets = (
        ('Configura√ß√µes de Comandas', {'fields': ('dia_vencimento_padrao', 'gerar_comandas_automaticamente')}),
        ('Metadados', {'fields': ('atualizado_em', 'atualizado_por'), 'classes': ('collapse',)}),
    )
    readonly_fields = ('atualizado_em',)

    def has_add_permission(self, request):
        return not ConfiguracaoSistema.objects.exists()

    def has_delete_permission(self, request, obj=None):
        return False


# -----------------------
# Fiador
# -----------------------
@admin.register(Fiador)
class FiadorAdmin(admin.ModelAdmin):
    """Admin para Fiador."""
    list_display = [
        'nome_completo', 'cpf', 'telefone', 'empresa_trabalho', 'created_at',
        'painel_whatsapp_button', 'locatario_link', 'recibo_button'
    ]
    list_filter = ['created_at', 'is_active']
    search_fields = ['nome_completo', 'cpf', 'rg', 'email', 'telefone']

    fieldsets = (
        ('üìã Dados Pessoais', {'fields': ('nome_completo', 'cpf', 'rg', 'data_nascimento')}),
        ('üë®‚Äçüë©‚Äçüë¶ Filia√ß√£o', {'fields': ('nome_pai', 'nome_mae'), 'classes': ['collapse']}),
        ('üìû Contatos', {'fields': ('telefone', 'email', 'outro_telefone', ('nome_contato_emergencia', 'telefone_contato_emergencia'))}),
        ('üè† Endere√ßo', {'fields': ('endereco_completo', 'cep')}),
        ('üíº Dados Profissionais', {'fields': ('empresa_trabalho', 'endereco_empresa', 'telefone_empresa', 'contato_empresa', 'tempo_empresa', 'renda_mensal')}),
        ('üïê Metadados', {'fields': ('created_at', 'updated_at', 'is_active'), 'classes': ['collapse']}),
    )
    readonly_fields = ['created_at', 'updated_at']

    @admin.display(description='WhatsApp')
    def painel_whatsapp_button(self, obj):
        telefone = getattr(obj, 'telefone', '') or ''
        digits = ''.join(ch for ch in telefone if ch.isdigit())
        if not digits:
            return '-'
        texto = f'Ol√° {obj.nome_completo}'
        wa_url = f'https://wa.me/{digits}?text={texto.replace(" ", "%20")}'
        return format_html('<a class="button" href="{}" target="_blank">üí¨ WhatsApp</a>', wa_url)

    @admin.display(description='Locat√°rio(s)')
    def locatario_link(self, obj):
        # Mostra links para locat√°rios que t√™m este fiador (defensivo)
        locatarios = Locatario.objects.filter(fiador=obj)
        if not locatarios.exists():
            return '-'
        links = []
        for loc in locatarios:
            url = reverse('admin:core_locatario_change', args=[loc.id])
            links.append(format_html('<a href="{}">{}</a>', url, loc.nome_razao_social))
        return format_html('<br>'.join(links))

    @admin.display(description='Recibo')
    def recibo_button(self, obj):
        # Implementa√ß√£o defensiva: leva ao change view do fiador (placeholder para a√ß√£o real)
        url = reverse('admin:core_fiador_change', args=[obj.pk])
        return format_html('<a class="button" href="{}" target="_blank">üßæ Ver/Emitir</a>', url)


# -----------------------
# Dashboard override (mantido)
# -----------------------
try:
    from .dashboard_views import admin_index
    admin.site.index = admin_index
except Exception:
    # Se a view customizada n√£o existir, mantemos o index padr√£o.
    pass

# >>> Restaurando PagamentoAdmin do core/admin.py.backup
class PagamentoAdmin(admin.ModelAdmin):
    form = PagamentoAdminForm
    
    actions = ['gerar_recibo']
    
    def gerar_recibo(self, request, queryset):
        """Gerar recibos em Word."""
        from .document_generator import DocumentGenerator
        generator = DocumentGenerator()
        
        recibos_gerados = []
        for pagamento in queryset:
            try:
                filename = generator.gerar_recibo_pagamento(pagamento.id)
                recibos_gerados.append(filename)
            except Exception as e:
                self.message_user(request, f'Erro ao gerar recibo {pagamento.numero_pagamento}: {e}', level='ERROR')
        
        if recibos_gerados:
            self.message_user(request, f'{len(recibos_gerados)} recibo(s) gerado(s) com sucesso!')
    
    gerar_recibo.short_description = "Gerar recibos Word"
    list_display = ('numero_pagamento', 'comanda', 'locatario_nome', 'valor_pago', 'data_pagamento', 'forma_pagamento', 'status')
    list_filter = ('status', 'forma_pagamento', 'data_pagamento')
    search_fields = ('numero_pagamento', 'comanda__numero_comanda', 'comanda__locacao__locatario__nome_razao_social')
    readonly_fields = ('numero_pagamento', 'data_confirmacao', 'created_at', 'updated_at')
    
    def get_readonly_fields(self, request, obj=None):
        """Mostrar info_contrato apenas na edi√ß√£o."""
        if obj:  # Editando
            return self.readonly_fields + ('info_contrato',)
        return self.readonly_fields  # Adicionando
    
    fieldsets = (
        ('Informa√ß√µes do Pagamento', {
            'fields': ('comanda', 'numero_pagamento', 'valor_pago', 'data_pagamento')
        }),
        ('Forma e Status', {
            'fields': ('forma_pagamento', 'status', 'data_confirmacao')
        }),
        ('Documenta√ß√£o', {
            'fields': ('comprovante', 'observacoes')
        }),
        ('Auditoria', {
            'fields': ('usuario_registro', 'created_at', 'updated_at'),
            'classes': ('collapse',)
        })
    )
    
    def locatario_nome(self, obj):
        """Display tenant name in list."""
        return obj.comanda.locacao.locatario.nome_razao_social
    locatario_nome.short_description = 'Locat√°rio'
    
    def info_contrato(self, obj):
        """Display clickable contract information."""
        from django.utils.html import format_html
        from django.urls import reverse
        
        locacao = obj.comanda.locacao
        locatario = locacao.locatario
        imovel = locacao.imovel
        
        # URL para loca√ß√£o
        url_locacao = reverse('admin:core_locacao_change', args=[locacao.id])
        # URL para locat√°rio
        url_locatario = reverse('admin:core_locatario_change', args=[locatario.id])
        
        return format_html(
            '<div style="padding: 10px; background: #f8f9fa; border-radius: 5px;">'
            '<strong>Contrato:</strong> <a href="{}" target="_blank" style="color: #007bff;">{}</a><br>'
            '<strong>Locat√°rio:</strong> <a href="{}" target="_blank" style="color: #007bff;">{}</a><br>'
            '<strong>Im√≥vel:</strong> {}<br>'
            '<strong>Valor Aluguel:</strong> R$ {:.2f}'
            '</div>',
            url_locacao,
            locacao.numero_contrato,
            url_locatario,
            locatario.nome_razao_social,
            imovel.endereco_completo,
            locacao.valor_aluguel
        )
    info_contrato.short_description = 'Informa√ß√µes do Contrato'
    
    def save_model(self, request, obj, form, change):
        if not change:
            obj.usuario_registro = request.user
        super().save_model(request, obj, form, change)


# @admin.register(TemplateContrato)
# Registro expl√≠cito adicionado para garantir exist√™ncia do changelist admin:core_pagamento_changelist
try:
    from .models import Pagamento
    try:
        admin.site.register(Pagamento, PagamentoAdmin)
    except Exception:
        # J√° registrado ou conflito ‚Äî ignorar
        pass
except Exception:
    # Import/registro falharam (nome diferente/dep√™ndencia) ‚Äî n√£o quebrar o admin
    pass
