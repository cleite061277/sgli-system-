"""
View para gera√ß√£o de contratos de loca√ß√£o
HABITAT PRO - Sistema de Gest√£o Imobili√°ria
"""
from django.shortcuts import get_object_or_404, redirect
from django.http import HttpResponse
from django.contrib.admin.views.decorators import staff_member_required
from django.contrib import messages
from datetime import datetime
import io

from docxtpl import DocxTemplate
from docx import Document
from docx.shared import Pt, RGBColor
from docx.enum.text import WD_ALIGN_PARAGRAPH

from .models import Locacao, TemplateContrato


def formatar_cpf_cnpj(valor):
    """Formata CPF ou CNPJ."""
    if not valor:
        return 'N√£o informado'
    
    numeros = ''.join(filter(str.isdigit, valor))
    
    if len(numeros) == 11:  # CPF
        return f"{numeros[:3]}.{numeros[3:6]}.{numeros[6:9]}-{numeros[9:]}"
    elif len(numeros) == 14:  # CNPJ
        return f"{numeros[:2]}.{numeros[2:5]}.{numeros[5:8]}/{numeros[8:12]}-{numeros[12:]}"
    
    return valor


def formatar_data(data):
    """Formata data para o padr√£o brasileiro."""
    if not data:
        return 'N√£o informado'
    
    if isinstance(data, str):
        return data
    
    return data.strftime('%d/%m/%Y')


def formatar_moeda(valor):
    """Formata valor monet√°rio."""
    if not valor:
        return 'R$ 0,00'
    
    return f"R$ {float(valor):,.2f}".replace(',', 'X').replace('.', ',').replace('X', '.')


def buscar_template_contrato(locacao):
    """Busca o template de contrato mais adequado."""
    locador = locacao.imovel.locador
    tipo_imovel = locacao.imovel.tipo_imovel
    
    # 1. Espec√≠fico do locador + tipo
    template = TemplateContrato.objects.filter(
        locador=locador,
        tipo_imovel=tipo_imovel,
        is_active=True
    ).first()
    
    if template:
        return template
    
    # 2. Espec√≠fico do locador
    template = TemplateContrato.objects.filter(
        locador=locador,
        tipo_imovel='',
        is_active=True
    ).first()
    
    if template:
        return template
    
    # 3. Espec√≠fico do tipo de im√≥vel
    template = TemplateContrato.objects.filter(
        locador=None,
        tipo_imovel=tipo_imovel,
        is_active=True
    ).first()
    
    if template:
        return template
    
    # 4. Template padr√£o
    template = TemplateContrato.objects.filter(
        is_default=True,
        is_active=True
    ).first()
    
    return template


def preparar_contexto_contrato(locacao):
    """Prepara o contexto com todas as vari√°veis do contrato."""
    locador = locacao.imovel.locador
    locatario = locacao.locatario
    imovel = locacao.imovel
    fiador = locatario.fiador
    
    contexto = {
        # LOCADOR
        'locador_nome': locador.nome_razao_social or 'N√£o informado',
        'locador_endereco_completo': locador.endereco_completo or 'N√£o informado',
        'locador_cep': locador.cep or 'N√£o informado',
        'locador_representante': locador.representante or locador.nome_razao_social or 'N√£o informado',
        
        # LOCAT√ÅRIO
        'locatario_nome': locatario.nome_razao_social or 'N√£o informado',
        'locatario_rg': locatario.rg or 'N√£o informado',
        'locatario_cpf_cnpj': formatar_cpf_cnpj(locatario.cpf_cnpj),
        'locatario_data_nascimento': formatar_data(locatario.data_nascimento),
        'locatario_telefone': locatario.telefone or 'N√£o informado',
        'locatario_filiacao_pai': locatario.nome_pai or 'N√£o informado',
        'locatario_filiacao_mae': locatario.nome_mae or 'N√£o informado',
        'locatario_endereco_completo': locatario.endereco_completo or 'N√£o informado',
        'locatario_fiador': fiador.nome_completo if fiador else 'N√£o possui fiador',
        
        # FIADOR - Dados Essenciais
        'fiador_nome': fiador.nome_completo if fiador else 'N√£o possui fiador',
        'fiador_cpf': formatar_cpf_cnpj(fiador.cpf) if fiador and fiador.cpf else 'N√£o informado',
        'fiador_rg': fiador.rg if fiador and fiador.rg else 'N√£o informado',
        'fiador_data_nascimento': formatar_data(fiador.data_nascimento) if fiador and fiador.data_nascimento else 'N√£o informado',
        'fiador_telefone': fiador.telefone if fiador and fiador.telefone else 'N√£o informado',
        'fiador_email': fiador.email if fiador and fiador.email else 'N√£o informado',
        'fiador_endereco_completo': fiador.endereco_completo if fiador and fiador.endereco_completo else 'N√£o informado',
        'fiador_cep': fiador.cep if fiador and fiador.cep else 'N√£o informado',
        
        # IM√ìVEL - Endere√ßo
        'imovel_endereco': imovel.endereco or 'N√£o informado',
        'imovel_numero': imovel.numero or 'S/N',
        'imovel_bairro': imovel.bairro or 'N√£o informado',
        'imovel_cidade': imovel.cidade or 'N√£o informado',
        'imovel_estado': imovel.estado or 'PR',
        'imovel_cep': imovel.cep or 'N√£o informado',
        
        # IM√ìVEL - Utilidades
        'imovel_conta_agua_esgoto': imovel.conta_agua_esgoto or 'N√£o informado',
        'imovel_numero_hidrometro': imovel.numero_hidrometro or 'N√£o informado',
        'imovel_unidade_consumidora_energia': imovel.unidade_consumidora_energia or 'N√£o informado',
        'imovel_descricao': imovel.descricao or 'Conforme vistoria anexa',
        
        # LOCA√á√ÉO - Valores
        'valor_aluguel': formatar_moeda(locacao.valor_aluguel),
        'locacao_data_inicio': formatar_data(locacao.data_inicio),
        'numero_contrato': locacao.numero_contrato or 'N√£o gerado',
        
        # Extras
        'data_hoje': datetime.now().strftime('%d/%m/%Y'),
        'cidade': 'PARANAGU√Å',
    }
    
    return contexto


def adicionar_numero_contrato_cabecalho(doc, numero_contrato):
    """Adiciona o n√∫mero do contrato no cabe√ßalho direito."""
    for section in doc.sections:
        header = section.header
        
        # Limpar cabe√ßalho existente
        for paragraph in header.paragraphs:
            paragraph.clear()
        
        # Adicionar n√∫mero do contrato
        paragraph = header.paragraphs[0] if header.paragraphs else header.add_paragraph()
        paragraph.alignment = WD_ALIGN_PARAGRAPH.RIGHT
        
        run = paragraph.add_run(f'Contrato N¬∫ {numero_contrato}')
        run.font.size = Pt(10)
        run.font.bold = True
        run.font.color.rgb = RGBColor(30, 58, 138)


@staff_member_required
def gerar_contrato_docx(request, pk):
    """Gera contrato em formato DOCX."""
    locacao = get_object_or_404(Locacao, pk=pk)
    
    # Buscar template
    template_obj = buscar_template_contrato(locacao)
    
    if not template_obj:
        messages.error(request, 'Nenhum template de contrato encontrado. Configure um template padr√£o.')
        return redirect('admin:core_locacao_change', pk)
    
    # Preparar contexto
    contexto = preparar_contexto_contrato(locacao)
    
    try:
        # Carregar template
        doc_template = DocxTemplate(template_obj.arquivo_template.path)
        
        # Preencher template
        doc_template.render(contexto)
        
        # Salvar em mem√≥ria
        docx_io = io.BytesIO()
        doc_template.save(docx_io)
        docx_io.seek(0)
        
        # Adicionar n√∫mero do contrato no cabe√ßalho
        doc = Document(docx_io)
        adicionar_numero_contrato_cabecalho(doc, locacao.numero_contrato)
        
        # Salvar novamente
        final_io = io.BytesIO()
        doc.save(final_io)
        final_io.seek(0)
        
        # Preparar resposta
        nome_arquivo = f'Contrato_{locacao.numero_contrato}_{locacao.locatario.nome_razao_social}'
        nome_arquivo = nome_arquivo.replace(' ', '_').replace('/', '-').replace('\\', '-')
        nome_arquivo = f'{nome_arquivo}.docx'
        
        response = HttpResponse(
            final_io.read(),
            content_type='application/vnd.openxmlformats-officedocument.wordprocessingml.document'
        )
        response['Content-Disposition'] = f'attachment; filename="{nome_arquivo}"'
        
        messages.success(request, f'‚úÖ Contrato gerado com sucesso: {nome_arquivo}')
        
        return response
        
    except Exception as e:
        messages.error(request, f'‚ùå Erro ao gerar contrato: {str(e)}')
        return redirect('admin:core_locacao_change', pk)


@staff_member_required
def gerar_contrato_pdf(request, pk):
    """Gera contrato em formato PDF (por enquanto redireciona para DOCX)."""
    messages.info(request, 'üìë Gera√ß√£o de PDF ser√° implementada em breve. Baixando DOCX.')
    return gerar_contrato_docx(request, pk)
