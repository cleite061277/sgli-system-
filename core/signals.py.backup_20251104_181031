"""
Signals para atualização automática de Comanda
"""
from django.db.models.signals import post_save, post_delete
from django.dispatch import receiver
from .models import Pagamento

@receiver(post_save, sender=Pagamento)
def atualizar_comanda_ao_salvar_pagamento(sender, instance, **kwargs):
    """Atualiza valor_pago da comanda quando pagamento é salvo"""
    comanda = instance.comanda
    
    # Recalcular valor_pago (soma de pagamentos confirmados)
    total_pago = comanda.pagamentos.filter(
        status='confirmado'
    ).aggregate(total=models.Sum('valor_pago'))['total'] or 0
    
    comanda.valor_pago = total_pago
    comanda.save(update_fields=['valor_pago'])

@receiver(post_delete, sender=Pagamento)
def atualizar_comanda_ao_deletar_pagamento(sender, instance, **kwargs):
    """Atualiza valor_pago da comanda quando pagamento é deletado"""
    comanda = instance.comanda
    
    # Recalcular valor_pago
    from django.db import models
    total_pago = comanda.pagamentos.filter(
        status='confirmado'
    ).aggregate(total=models.Sum('valor_pago'))['total'] or 0
    
    comanda.valor_pago = total_pago
    comanda.save(update_fields=['valor_pago'])
