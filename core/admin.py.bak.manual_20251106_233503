from django.db.models import Sum, Value, Q
from django.db.models.functions import Coalesce
from decimal import Decimal
from django.utils.html import format_html

# Limpado e corrigido por Copilot â€” versÃ£o recomendada
from django.contrib import admin
import uuid
from django.db import transaction, IntegrityError
from django.utils import timezone
from django.utils.html import format_html
from django.urls import reverse
from django.db.models import Sum, Q

from .models import (
    Usuario, Locador, Imovel, Locatario, Locacao,
    Comanda, Pagamento, Fiador, TemplateContrato,
    ConfiguracaoSistema, LogGeracaoComandas
)

from .forms import PagamentoAdminForm

# FormSet customizado para preencher usuario_registro
from django.forms import BaseInlineFormSet

class UsuarioAdmin(admin.ModelAdmin):
    """Admin organizado para Usuario"""
    list_display = ['username', 'get_full_name', 'email', 'tipo_usuario', 'is_staff', 'is_active', 'date_joined']
    list_filter = ['tipo_usuario', 'is_active', 'is_staff', 'date_joined']
    search_fields = ['username', 'email', 'first_name', 'last_name', 'cpf']

    fieldsets = (
        ('ğŸ” AutenticaÃ§Ã£o', {'fields': ('username', 'password')}),
        ('ğŸ‘¤ Dados Pessoais', {'fields': ('first_name', 'last_name', 'email', 'cpf', 'telefone', 'avatar')}),
        ('ğŸ­ Perfil do Sistema', {'fields': ('tipo_usuario',)}),
        ('ğŸ”‘ PermissÃµes', {
            'fields': ('is_active', 'is_staff', 'is_superuser', 'groups', 'user_permissions'),
            'classes': ['collapse'],
        }),
        ('ğŸ“… Datas Importantes', {
            'fields': ('date_joined', 'last_login'),
            'classes': ['collapse'],
        }),
    )
    readonly_fields = ['date_joined', 'last_login']


# -----------------------
# Locador
# -----------------------
@admin.register(Locador)
class LocadorAdmin(admin.ModelAdmin):
    list_display = [
        'nome_razao_social',
        'representante',
        'tipo_locador',
        'cpf_cnpj',
        'telefone',
        'email',
        'is_active',
    ]
    list_filter = ['tipo_locador', 'is_active', 'created_at']
    search_fields = ['nome_razao_social', 'representante', 'cpf_cnpj', 'email', 'telefone']

    fieldsets = (
        ('ğŸ“‹ Dados BÃ¡sicos', {'fields': ('usuario', 'tipo_locador', 'nome_razao_social', 'representante', 'cpf_cnpj')}),
        ('ğŸ“ Contatos', {'fields': ('telefone', 'email')}),
        ('ğŸ  EndereÃ§o', {'fields': ('endereco_completo', 'cep')}),
        ('ğŸ“ ObservaÃ§Ãµes', {'fields': ('observacoes',), 'classes': ['collapse']}),
        ('ğŸ• Metadados', {'fields': ('created_at', 'updated_at', 'is_active'), 'classes': ['collapse']}),
    )
    readonly_fields = ['created_at', 'updated_at']


# -----------------------
# ImÃ³vel
# -----------------------
@admin.register(Imovel)
class ImovelAdmin(admin.ModelAdmin):
    list_display = ['codigo_imovel', 'tipo_imovel', 'status', 'endereco', 'cidade', 'valor_aluguel', 'locador', 'is_active']
    list_filter = ['tipo_imovel', 'status', 'cidade', 'estado', 'is_active', 'created_at']
    search_fields = ['codigo_imovel', 'endereco', 'bairro', 'cidade', 'locador__nome_razao_social']

    fieldsets = (
        ('ğŸ“‹ InformaÃ§Ãµes BÃ¡sicas', {'fields': ('locador', 'codigo_imovel', 'tipo_imovel', 'status')}),
        ('ğŸ“ EndereÃ§o', {'fields': ('endereco', 'numero', 'bairro', 'cidade', 'estado', 'cep')}),
        ('ğŸ“ CaracterÃ­sticas', {'fields': ('area_total', 'quartos', 'banheiros')}),
        ('ğŸ’° Valores', {'fields': ('valor_aluguel', 'valor_condominio')}),
        ('âš¡ Utilidades / Contas', {
            'fields': ('conta_agua_esgoto', 'numero_hidrometro', 'unidade_consumidora_energia'),
            'description': 'InformaÃ§Ãµes de contas de consumo do imÃ³vel'
        }),
        ('ğŸ“ DescriÃ§Ã£o', {'fields': ('descricao',), 'classes': ['collapse']}),
        ('ğŸ• Metadados', {'fields': ('created_at', 'updated_at', 'is_active'), 'classes': ['collapse']}),
    )
    readonly_fields = ['created_at', 'updated_at']


# -----------------------
# LocatÃ¡rio
# -----------------------
@admin.register(Locatario)
class LocatarioAdmin(admin.ModelAdmin):
    list_display = ['nome_razao_social', 'cpf_cnpj', 'telefone', 'email', 'empresa_trabalho', 'tem_fiador', 'is_active']
    list_filter = ['created_at', 'is_active']
    search_fields = ['nome_razao_social', 'cpf_cnpj', 'rg', 'email', 'telefone', 'empresa_trabalho']

    fieldsets = (
        ('ğŸ“‹ Dados Pessoais', {'fields': ('nome_razao_social', 'cpf_cnpj', 'rg', 'data_nascimento')}),
        ('ğŸ‘¨â€ğŸ‘©â€ğŸ‘¦ FiliaÃ§Ã£o', {'fields': ('nome_pai', 'nome_mae'), 'classes': ['collapse']}),
        ('ğŸ“ Contatos', {'fields': ('telefone', 'email', 'outro_telefone', ('nome_contato_emergencia', 'telefone_contato_emergencia'))}),
        ('ğŸ  EndereÃ§o', {'fields': ('endereco_completo',)}),
        ('ğŸ’¼ Dados Profissionais', {'fields': ('empresa_trabalho', 'endereco_empresa', 'telefone_empresa', 'contato_empresa', 'tempo_empresa', 'renda_mensal')}),
        ('ğŸ›¡ï¸ Garantia', {'fields': ('fiador',), 'description': 'Selecione um fiador cadastrado ou deixe em branco se nÃ£o houver'}),
        ('ğŸ• Metadados', {'fields': ('created_at', 'updated_at', 'is_active'), 'classes': ['collapse']}),
    )
    readonly_fields = ['created_at', 'updated_at']

    @admin.display(description='Fiador', boolean=True)
    def tem_fiador(self, obj):
        return obj.fiador is not None


# -----------------------
# LocaÃ§Ã£o (contratos)
# -----------------------
@admin.register(Locacao)
class LocacaoAdmin(admin.ModelAdmin):
    """Admin atualizado com geraÃ§Ã£o de contratos"""
    list_display = ('numero_contrato', 'imovel', 'locatario', 'status', 'data_inicio', 'data_fim')
    list_filter = ('status', 'is_active', 'created_at')
    search_fields = ('numero_contrato', 'imovel__codigo_imovel', 'locatario__nome_razao_social')
    readonly_fields = ['created_at', 'updated_at']

    actions = ['gerar_contrato_pdf_action', 'gerar_contrato_docx_action', 'gerar_contrato']

    fieldsets = (
        ('ğŸ“‹ InformaÃ§Ãµes BÃ¡sicas', {
            'fields': ('numero_contrato', 'imovel', 'locatario', 'status'),
            'description': 'âš ï¸ Deixe o nÃºmero do contrato VAZIO para gerar automaticamente'
        }),
        ('ğŸ“… Datas', {'fields': ('data_inicio', 'data_fim')}),
        ('ğŸ’° Valores', {'fields': ('valor_aluguel', 'dia_vencimento')}),
        ('ğŸ• Metadados', {'fields': ('created_at', 'updated_at', 'is_active'), 'classes': ['collapse']}),
    )

    def get_form(self, request, obj=None, **kwargs):
        """Remove required do numero_contrato para permitir geraÃ§Ã£o automÃ¡tica"""
        form = super().get_form(request, obj, **kwargs)
        if 'numero_contrato' in form.base_fields:
            form.base_fields['numero_contrato'].required = False
            form.base_fields['numero_contrato'].help_text = 'âœ¨ Deixe vazio para gerar automaticamente'
        return form

    def change_view(self, request, object_id, form_url='', extra_context=None):
        """Adiciona botÃµes de gerar contrato."""
        extra_context = extra_context or {}
        obj = self.get_object(request, object_id)
        if obj:
            extra_context['show_contrato_buttons'] = True
            extra_context['contrato_docx_url'] = reverse('gerar_contrato_docx', args=[obj.pk])
            extra_context['contrato_pdf_url'] = reverse('gerar_contrato_pdf', args=[obj.pk])
        return super().change_view(request, object_id, form_url, extra_context)

    @admin.action(description='ğŸ“„ Gerar Contrato PDF')
    def gerar_contrato_pdf_action(self, request, queryset):
        if queryset.count() == 1:
            from .contrato_generator import gerar_contrato_pdf
            return gerar_contrato_pdf(queryset.first())
        else:
            self.message_user(request, 'âŒ Selecione apenas UMA locaÃ§Ã£o', level='error')

    @admin.action(description='ğŸ“ Gerar Contrato DOCX')
    def gerar_contrato_docx_action(self, request, queryset):
        if queryset.count() == 1:
            from .contrato_generator import gerar_contrato_docx
            return gerar_contrato_docx(queryset.first())
        else:
            self.message_user(request, 'âŒ Selecione apenas UMA locaÃ§Ã£o', level='error')

    def gerar_contrato(self, request, queryset):
        """Gerar contratos em Word (bulk action)."""
        from .document_generator import DocumentGenerator
        generator = DocumentGenerator()

        contratos_gerados = []
        for locacao in queryset:
            try:
                filename = generator.gerar_contrato_locacao(locacao.id)
                contratos_gerados.append(filename)
            except Exception as e:
                self.message_user(request, f'Erro ao gerar contrato {locacao.numero_contrato}: {e}', level='ERROR')

        if contratos_gerados:
            self.message_user(request, f'{len(contratos_gerados)} contrato(s) gerado(s) com sucesso!')


# -----------------------
# Comanda
# -----------------------


class PagamentoInline(admin.TabularInline):
    model = Pagamento
    extra = 0
    fields = ['data_pagamento', 'valor_pago', 'forma_pagamento', 'status', 'comprovante', 'recibo_actions']
    readonly_fields = ['numero_pagamento', 'created_at', 'recibo_actions']

    def get_formset(self, request, obj=None, **kwargs):
        formset = super().get_formset(request, obj, **kwargs)
        formset.request = request
        return formset

    @admin.display(description='Recibo')
    def recibo_actions(self, obj):
        if not obj or not obj.pk:
            return '-'

        status = (getattr(obj, 'status', '') or '').lower()
        is_confirmed = status == 'confirmado' or status == getattr(obj.StatusPagamento, 'CONFIRMADO', '').lower()

        try:
            view_url = reverse('pagina_recibo_pagamento', args=[obj.pk])
            download_url = reverse('download_recibo_pagamento', args=[obj.pk])
        except Exception:
            view_url = f'/pagamento/{obj.pk}/recibo/'
            download_url = f'/pagamento/{obj.pk}/recibo/download/'

        if not is_confirmed:
            return format_html('<span style="color: #999; font-style: italic;">Aguardando confirmaÃ§Ã£o</span>')

        return format_html(
            '<a class="button" href="{}" target="_blank" style="background:#28a745;color:#fff;margin-right:6px;">ğŸ§¾ Ver</a>'
            '<a class="button" href="{}" target="_blank" style="background:#667eea;color:#fff;margin-right:6px;">ğŸ“¥ Word</a>'
            '<a class="button" href="{}" style="background:#3b82f6;color:#fff;margin-right:6px;">ğŸ“§ Email</a>',
            view_url, download_url, view_url
        )

    def save_new(self, form, formset, commit=True):
        obj = super().save_new(form, formset, commit=False)
        if not obj.usuario_registro_id and hasattr(formset, 'request'):
            obj.usuario_registro = formset.request.user
        if commit:
            obj.save()
        return obj

    def has_delete_permission(self, request, obj=None):
        if obj and getattr(obj, 'status', None) == 'confirmado':
            return False
        return True

@admin.register(Comanda)
class ComandaAdmin(admin.ModelAdmin):
    @admin.display(description='â° Dias de Atraso')
    def dias_atraso_display(self, obj):
        """
        Exibe os dias de atraso no admin (indentaÃ§Ã£o correta dentro da classe).
        """
        from django.utils.html import format_html
        try:
            dias = obj.dias_atraso() if hasattr(obj, 'dias_atraso') else 0
        except Exception:
            dias = 0

        if dias == 0:
            return format_html('<span style="color: #28a745; font-size: 16px;">âœ“ Em dia</span>')
        elif dias > 0:
            return format_html(
                '<span style="color: #dc3545; font-size: 16px; font-weight: bold;">âš ï¸ {} dia(s) de atraso</span>',
                dias
            )
        else:
            return format_html(
                '<span style="color: #17a2b8; font-size: 16px;">ğŸ“… Vence em {} dia(s)</span>',
                abs(dias)
            )
    # BotÃ£o para enviar WhatsApp (implementaÃ§Ã£o defensiva)
    @admin.display(description='WhatsApp')
    # BotÃ£o para enviar WhatsApp (implementaÃ§Ã£o defensiva)
    @admin.display(description='WhatsApp')
    def painel_whatsapp_button(self, obj):
        """
        Gera botÃ£o/link para abrir o WhatsApp com mensagem itemizada e total da comanda.
        ImplementaÃ§Ã£o defensiva â€” nÃ£o quebra o admin em caso de erro.
        """
        from django.utils.html import format_html
        from urllib.parse import quote_plus
        from decimal import Decimal
        from django.conf import settings

        try:
            # 1) localizar telefone de forma defensiva (vÃ¡rias possibilidades)
            telefone = None
            if getattr(obj, 'locacao', None):
                loc = obj.locacao
                telefone = getattr(getattr(loc, 'locatario', None), 'telefone', None) or telefone
                telefone = getattr(getattr(loc, 'usuario_registro', None), 'telefone', None) or telefone
            # fallback: telefone direto no objeto
            telefone = telefone or getattr(obj, 'telefone', None) or getattr(obj, 'telefone_contato', None)

            if not telefone:
                return '-'

            # extrair apenas dÃ­gitos
            digits = ''.join(ch for ch in str(telefone) if ch.isdigit())
            # prefixar DDI padrÃ£o se configurado e nÃºmero curto
            if getattr(settings, "WHATSAPP_DEFAULT_DDI", None) and len(digits) <= 11:
                digits = f"{settings.WHATSAPP_DEFAULT_DDI}{digits}"

            # validaÃ§Ã£o simples: exige pelo menos 8 dÃ­gitos
            if len(digits) < 8:
                return '-'

            # 2) tentar usar um formatter existente (se houver) - integraÃ§Ã£o opcional
            texto = None
            try:
                from core.notifications import message_formatter as mf
                if hasattr(mf, "format_comanda_whatsapp"):
                    texto = mf.format_comanda_whatsapp(obj)
                elif hasattr(mf, "format_whatsapp_message"):
                    texto = mf.format_whatsapp_message(obj)
            except Exception:
                texto = None

            # 3) se nÃ£o houver formatter, montar a mensagem itemizada localmente
            if not texto:
                def dec(field):
                    try:
                        raw = getattr(obj, field, None)
                        return Decimal(raw or 0)
                    except Exception:
                        return Decimal(0)

                mapping = [
                    ("Aluguel", "valor_aluguel"),
                    ("CondomÃ­nio", "valor_condominio"),
                    ("IPTU", "valor_iptu"),
                    ("AdministraÃ§Ã£o", "valor_administracao"),
                    ("Outros (crÃ©dito)", "outros_creditos"),
                    ("Outros (dÃ©bito)", "outros_debitos"),
                    ("Multa", "valor_multa"),
                    ("Juros", "valor_juros"),
                    ("Desconto", "desconto"),
                ]

                itens = []
                for label, field in mapping:
                    val = dec(field)
                    if val and val != Decimal("0"):
                        if field in ("outros_creditos", "desconto"):
                            itens.append(f"{label}: -R$ {abs(val):,.2f}")
                        else:
                            itens.append(f"{label}: R$ {val:,.2f}")

                # total preferindo o mÃ©todo do modelo se existir
                total_oficial = None
                try:
                    if callable(getattr(obj, "valor_total", None)):
                        total_oficial = obj.valor_total()
                    else:
                        total_oficial = dec("valor_total")
                except Exception:
                    total_oficial = None

                if total_oficial in (None, 0):
                    soma_positivos = sum(dec(f) for _, f in mapping if f not in ("desconto", "outros_creditos"))
                    soma_creditos = dec("desconto") + dec("outros_creditos")
                    total_used = soma_positivos - soma_creditos
                else:
                    total_used = Decimal(total_oficial or 0)

                partes = []
                partes.append(f"OlÃ¡! Recibo da comanda {getattr(obj, 'numero_comanda', '')}")
                nome = ""
                try:
                    if getattr(obj, "locacao", None):
                        nome = getattr(getattr(obj.locacao, "locatario", None), "nome_razao_social", None) \
                            or getattr(getattr(obj.locacao, "usuario_registro", None), "get_full_name", None)
                    if not nome:
                        nome = getattr(obj, "locacao_info", None) or ""
                except Exception:
                    nome = ""
                if nome:
                    partes.append(f"Cliente: {nome}")

                partes.append("")  # linha em branco antes dos itens
                partes.append("Itens:")
                for it in itens:
                    partes.append(f"- {it}")

                partes.append("")  # linha em branco antes do total
                partes.append(f"Total: R$ {Decimal(total_used):,.2f}")

                texto = "\n".join(partes)

            # 4) codificar e construir URL
            texto_enc = quote_plus(texto)
            wa_url = f"https://wa.me/{digits}?text={texto_enc}"
            return format_html('<a class="button" href="{}" target="_blank">ğŸ’¬ WhatsApp</a>', wa_url)

        except Exception:
            return '-'
        """BotÃ£o para visualizar pagamento"""
        url = reverse('admin:core_pagamento_change', args=[obj.pk])
        return format_html(
            '<a class="button" href="{}" target="_blank">ğŸ§¾ Ver Detalhes</a>',
            url
        )

    @admin.action(description='ğŸ§¾ Gerar recibo (Word)')
    def gerar_recibo(self, request, queryset):
        from .document_generator import DocumentGenerator
        generator = DocumentGenerator()
        recibos_gerados = []
        for pagamento in queryset:
            try:
                filename = generator.gerar_recibo_pagamento(pagamento.id)
                recibos_gerados.append(filename)
            except Exception as e:
                self.message_user(request, f'Erro ao gerar recibo {pagamento.numero_pagamento}: {e}', level='ERROR')
        if recibos_gerados:
            self.message_user(request, f'{len(recibos_gerados)} recibo(s) gerado(s) com sucesso!')


# -----------------------
# TemplateContrato
# -----------------------
@admin.register(TemplateContrato)
class TemplateContratoAdmin(admin.ModelAdmin):
    list_display = ('nome', 'locador', 'tipo_imovel', 'is_default', 'created_at')
    list_filter = ('is_default', 'tipo_imovel', 'locador')
    search_fields = ('nome', 'descricao')
    fieldsets = (
        ('InformaÃ§Ãµes BÃ¡sicas', {'fields': ('nome', 'descricao', 'arquivo_template')}),
        ('AssociaÃ§Ãµes', {'fields': ('locador', 'tipo_imovel', 'is_default'), 'description': 'Defina quando este template deve ser usado'})
    )


# -----------------------
# ConfiguracaoSistema (singleton)
# -----------------------
@admin.register(ConfiguracaoSistema)
class ConfiguracaoSistemaAdmin(admin.ModelAdmin):
    fieldsets = (
        ('ConfiguraÃ§Ãµes de Comandas', {'fields': ('dia_vencimento_padrao', 'gerar_comandas_automaticamente')}),
        ('Metadados', {'fields': ('atualizado_em', 'atualizado_por'), 'classes': ('collapse',)}),
    )
    readonly_fields = ('atualizado_em',)

    def has_add_permission(self, request):
        return not ConfiguracaoSistema.objects.exists()

    def has_delete_permission(self, request, obj=None):
        return False


# -----------------------
# Fiador
# -----------------------
@admin.register(Fiador)
class FiadorAdmin(admin.ModelAdmin):
    """Admin para Fiador."""
    list_display = [
        'nome_completo', 'cpf', 'telefone', 'empresa_trabalho', 'created_at',
        'painel_whatsapp_button', 'locatario_link', 'recibo_button'
    ]
    list_filter = ['created_at', 'is_active']
    search_fields = ['nome_completo', 'cpf', 'rg', 'email', 'telefone']

    fieldsets = (
        ('ğŸ“‹ Dados Pessoais', {'fields': ('nome_completo', 'cpf', 'rg', 'data_nascimento')}),
        ('ğŸ‘¨â€ğŸ‘©â€ğŸ‘¦ FiliaÃ§Ã£o', {'fields': ('nome_pai', 'nome_mae'), 'classes': ['collapse']}),
        ('ğŸ“ Contatos', {'fields': ('telefone', 'email', 'outro_telefone', ('nome_contato_emergencia', 'telefone_contato_emergencia'))}),
        ('ğŸ  EndereÃ§o', {'fields': ('endereco_completo', 'cep')}),
        ('ğŸ’¼ Dados Profissionais', {'fields': ('empresa_trabalho', 'endereco_empresa', 'telefone_empresa', 'contato_empresa', 'tempo_empresa', 'renda_mensal')}),
        ('ğŸ• Metadados', {'fields': ('created_at', 'updated_at', 'is_active'), 'classes': ['collapse']}),
    )
    readonly_fields = ['created_at', 'updated_at']

    @admin.display(description='WhatsApp')
    def painel_whatsapp_button(self, obj):
        telefone = getattr(obj, 'telefone', '') or ''
        digits = ''.join(ch for ch in telefone if ch.isdigit())
        if not digits:
            return '-'
        texto = f'OlÃ¡ {obj.nome_completo}'
        wa_url = f'https://wa.me/{digits}?text={texto.replace(" ", "%20")}'
        return format_html('<a class="button" href="{}" target="_blank">ğŸ’¬ WhatsApp</a>', wa_url)

    @admin.display(description='LocatÃ¡rio(s)')
    def locatario_link(self, obj):
        # Mostra links para locatÃ¡rios que tÃªm este fiador (defensivo)
        locatarios = Locatario.objects.filter(fiador=obj)
        if not locatarios.exists():
            return '-'
        links = []
        for loc in locatarios:
            url = reverse('admin:core_locatario_change', args=[loc.id])
            links.append(format_html('<a href="{}">{}</a>', url, loc.nome_razao_social))
        return format_html('<br>'.join(links))

    @admin.display(description='Recibo')
    def recibo_button(self, obj):
        # ImplementaÃ§Ã£o defensiva: leva ao change view do fiador (placeholder para aÃ§Ã£o real)
        url = reverse('admin:core_fiador_change', args=[obj.pk])
        return format_html('<a class="button" href="{}" target="_blank">ğŸ§¾ Ver/Emitir</a>', url)


# -----------------------
# Dashboard override (mantido)
# -----------------------
try:
    from .dashboard_views import admin_index
    admin.site.index = admin_index
except Exception:
    # Se a view customizada nÃ£o existir, mantemos o index padrÃ£o.
    pass
